<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc PUBLIC "-//IETF//DTD RFC 2629//EN"
	"http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC2616 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2616.xml">
<!ENTITY ASCII SYSTEM "http://xml.resource.org/public/rfc/bibxml2/reference.ANSI.X3-4.1986.xml">
<!ENTITY HTML5 SYSTEM "http://xml.resource.org/public/rfc/bibxml4/reference.W3C.WD-html5-20080122.xml">
<!ENTITY % rfc2629-xhtml PUBLIC "-//IETF//ENTITIES XHTML subset for RFC 2629//EN" "http://xml.resource.org/authoring/rfc2629-xhtml.ent">
<!ENTITY % rfc2629-other PUBLIC "-//IETF//ENTITIES Other for RFC 2629//EN" "http://xml.resource.org/authoring/rfc2629-other.ent">
%rfc2629-xhtml;
%rfc2629-other;
]>
<?xml-stylesheet type="text/xsl" href="rfc2629.xslt"?>
<?rfc toc="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<?rfc comments="yes"?>
<?rfc strict="yes"?>
<?rfc inline="yes"?>
<rfc ipr="noDerivatives3978" category="info" updates="2616">
<front>
	<title>Tolerant HTTP Parsing</title>
	<author initials="G.M." surname="Sneddon" fullname="Geoffrey Sneddon">
	<!-- I work for no organisation, so no need for this to even be opened. -->
	<organization/>
	<address>
		<postal>
			<street>Toll Park</street>
			<street>20 Hepburn Gardens</street>
			<city>St Andrews</city>
			<region>Fife</region>
			<code>KY16 9DE</code>
			<country>GB</country>
		</postal>
		<phone>+44 7807 360 291</phone>
		<email>geoffers@gmail.com</email>
		<uri>http://gsnedders.com/</uri>
	</address>
	</author>
	<!-- This is omitted while in draft, else I always forget to change it -->
	<date/>
	<area>Applications</area>
	<keyword>I-D</keyword>
	<keyword>Internet-Draft</keyword>
	<keyword>HTTP</keyword>
	<keyword>HyperText Transfer Protocol</keyword>
	<!-- !Abstract -->
	<abstract>
		<t>The HyperText Transfer Protocol (HTTP) has been widely used by the 
		  World Wide Web (WWW) since 1990. This specification updates RFC 2616,
		  defining how to parse HTTP requests and responses in a way that is
		  compatible with user-agents (UAs) and servers at the time of writing.</t>
	</abstract>
	
	<!-- Editorial Note -->
	<note title="Editorial Note">
		<t><cref>Remove this section upon publication.</cref></t>
		
		<t>This is a work in progress, and may change in part, or in whole. Do
		  not take anything in any draft version to be final. Comments are
		  very welcome, and should be sent to
		  <eref target="mailto:geoffers@gmail.com">geoffers@gmail.com</eref>
		  .</t>
		
		<t>Known issues as of writing:</t>
		
		<t><list style="symbols">
			<t>The majority of the parsing algorithm is yet to be written.</t>
			
			<t><xref target="RFC2616"/> isn't properly referenced.</t>
			
			<t>Security Considerations needs:
				<list style="letters">
					<t>"one thing for the security section of that draft is the
					  need for implementations to follow the spec exactly lest
					  they be vulnerable to content stuffing that abuses
					  differences in parsing algorithms" - Hixie</t>
					
					<t>Most are unchanged from <xref target="RFC2616"/>.</t>
				</list>
			</t>
			
			<t><xref target="unescaping-quoted-strings"/> needs to be rewritten,
			  as it currently breaks on anything that contains a double
			  quotation mark.</t>
			
			<t>Break parsing/post-parsing into two distinct sections, and have
			  common subroutines seperated out.</t>
			
			<t>Split up acknowledgements and contributors.</t>
			
			<t>Show effective valid header name/values as POSIX regex (as this
			  has a formal specification and is therefore most appropriate for
			  an I-D/RFC <eref target="http://www.ietf.org/IESG/STATEMENTS/pseudo-code-in-specs.txt"/>).
			  Extend this beyond header name/values?</t>
			
			<t>Investigate whether a reference that needs to be read to
			  understand an informative section be normative or not (as the
			  regex would only be inforamtive).</t>
			
			<t>Define handling of various things, which should make <xref target="further-suggestions"/>
			  obsolete. This means moving Content-Type sniffing into this spec,
			  as part of parsing the Content-Type header, as well as defining
			  how to resolve the base IRI of an HTTP document.</t>
			
			<t>Add anchor attributes for each and every section.</t>
			
			<t>Look over <eref target="http://www.ietf.org/ID-Checklist.html"/>
			  and <eref target="http://www.rfc-editor.org/rfc-editor/instructions2authors.txt"/>.</t>
			
			<t>Do we really need to expand HTTP anywhere? It's listed as being
			  so well known there is no need to expand it. Either we expand it
			  elsewhere apart from the abstract (i.e., in the title and its
			  first occurrence in the body of the document), or nowhere at all.</t>
		</list></t>
	</note>
</front>
<middle>
	<!-- !Introduction -->
	<section title="Introduction">
		<t>Ever since HTTP's conception, there have never been any standards
		  regarding its parsing in the real world. <xref target="RFC2616"/>
		  tried to improve this situation with a section (19.3) entitled 
		  "Tolerant Applications", providing advice about parsing requests and
		  responses. However, it did not go into specific details that are
		  needed for interoperability with current (non-conformant) user-agents
		  (UAs) and servers. The lack of any current specification defining such
		  specifics makes it hard for any new UA to be created without first
		  spending large amounts of time reverse engineering what is in cases
		  purely bizarre behaviour, which unless you know about beforehand, you
		  may not write enough test cases to find some of the oddest behaviour.</t>
		
		<t>This specification aims to help the above mentioned problem by
		  documenting the behaviour of UAs at the time of writing. Hopefully,
		  over time, the real world will align itself with this specification.</t>
		
		<!-- !Notational Conventions -->
		<section title="Notational Conventions">
			<t>This specification is defined in terms of the US-ASCII character
			  set, as defined in <xref target="ANSI.X3-4.1986"/>.</t>
			
			<t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL",
			  "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
			  "OPTIONAL" in this document are to be interpreted as described in
			  <xref target="RFC2119"/>.</t>
		</section>
		
		<!-- !Conformance Requirements -->
		<section title="Conformance Requirements">
			<t>The conformance requirements of this specification are phrased as
			  algorithms and may be implemented in any manner, so long as the
			  end result is equivalent (in particular, the algorithms defined in
			  this specification are intended to be easy to follow, and not
			  intended to be performant).</t>
			
			<t>Implementations may impose implementation-specific limits on
			  otherwise unconstrained inputs, e.g., to prevent denial of service
			  attacks, to guard against running out of memory, or to work around
			  platform-specific limitations.</t>
		</section>
	</section>
	
	<!-- !Errors -->
	<section title="Errors">
		<t>This section describes the behaviour that MUST be taken on certain
		  types of errors.</t>
		
		<section title="Fatal Error" anchor="fatal-error">
			<t>If it is a request being parsed, the server/proxy MUST respond
			  with 400 (Bad Request); if it is a response being parsed, the
			  client MUST notify the user of the error (e.g., by displaying a
			  graphical error message, by sounding an audible warning, by
			  logging the error in an error log).</t>
		</section>
	</section>
	
	<!-- !Tokenisation -->
	<section title="Tokenisation">
		<t>An HTTP request/response MUST be broken up into header-fields and
		  message-body following the request production for requests, and the
		  response production for responses. If the appropriate production fails
		  to match, it is a <xref target="fatal-error">fatal error</xref>.</t>
	</section>
	
	<!-- !Parsing -->
	<section title="Parsing">
		<t>This section details the processing follows that tokenising.</t>
		
		<!-- !Unescaping Quoted Strings -->
		<section title="Unescaping Quoted Strings" anchor="unescaping-quoted-strings">
			<t>To unescape a quoted string (i.e., a string that follows the
			  quoted-string specification in <xref target="RFC2616"/>), the
			  following algorithm MUST be run:</t>
			
			<t><list style="numbers">
				<t>Let "input" be the string being parsed.</t>
				
				<t>Let "string" be the unescaped output string.</t>
				
				<t>Let "position" be a pointer into input, initially pointing at
				  the start of the string.</t>
				
				<t>If "input" has exactly two 0x22 (US-ASCII quotation mark)
				  bytes, and they are the first and last bytes of the string,
				  then continue with this algorithm. Otherwise, return "input",
				  as the string does not need to be unescaped.</t>
				
				<t>Advance "position" to the next byte.</t>
				
				<t>If "position" points to a 0x5C (US-ACSII backslash), skip to
				  step 8, otherwise continue on to step 7.</t>
				
				<t>Append the current byte (that "position" points to) to
				  "string".</t>
				
				<t>Advance "position" to the next byte.</t>
				
				<t>If "position" is not past the end of "input", return to step
				  6 of this algorithm.</t>
				
				<t>Remove the final byte from "string".</t>
				
				<t>Return "string".</t>
			</list></t>
		</section>
	</section>
	
	<!-- !Security Considerations -->
	<section title="Security Considerations">
		<t><cref>This section is just a very rough draft.</cref></t>
		
		<t>This specification is just a parsing algorithm, and therefore
		  any risks (excluding implementations issues such as buffer overflows)
		  are inherited from <xref target="RFC2616"/>.</t>
	</section>
	
	<!-- !IANA Considerations -->
	<section title="IANA Considerations">
		<t>This document has no actions for IANA.</t>
	</section>
</middle>
<back>
	<!-- !Normative References -->
	<references title="Normative References">
		&ASCII;
		&RFC2119;
		&RFC2616;
	</references>
	
	<!-- !Informative References -->
	<references title="Informative References">
		&HTML5;
	</references>
	
	<!-- !Contributors -->
	<section title="Contributors">
		<t>The following people contributed to this document (often by helping
		  to reverse engineer current behaviour, or helping to review this
		  document): Ian Hickson, Philip Taylor.</t>
	</section>
	
	<!-- !Further Suggestions -->
	<section title="Further Suggestions" anchor="further-suggestions">
		<t>This section is informative.</t>
		
		<t>While the scope of this specification is only parsing of HTTP
		  requests and responses, there are several other things that I am aware
		  of that should be pointed out to anyone implementing
		  <xref target="RFC2616"/>:</t>
		
		<t><list style="symbols">
			<t>The Content-Location header SHOULD be ignored. This is due to
			  multiple versions of Microsoft Internet Information Services (IIS)
			  sending incorrect Content-Location headers. Implementing this as
			  required by <xref target="RFC2616"/> will break a significant
			  number of websites.</t>
			
			<t>The Content-Type SHOULD NOT on its own be trusted. Content-Type
			  sniffing as defined in <xref target="W3C.WD-html5-20080122"/>
			  SHOULD be used to determine the true type of the resource. This
			  is due to a large number of websites sending incorrect
			  Content-Type headers, often because the maintainer of the website
			  cannot change the header, or because the file extension/MIME type
			  database is outdated.</t>
		</list></t>
	</section>
</back>
</rfc>